<?php
session_start();
$username = $_POST['username'];
require("auth.php");
?>
<html>
<body>
<?

require("dbfunctions.php");
$dbh = db_connect();



if ($username)
{//process
if(isvaliduser($dbh, $username))
 {echo "User already exists.";}
else
{

if($username=="grossber")
{echo "Prohibited user. This user has been banned from Plans.";}
else {


if (!$password)
{srand(time());
$password = rand(0,999999);}
if (!$email)
{$email = $username . "@grinnell.edu";}

$crpassword = crypt($password, "ab");
$myrow = 
array("",$username,"",$crpassword,$email,"","","","","","","",$gradyear,"70","14","", "");
add_row($dbh, "accounts", $myrow);

mysql_query("UPDATE accounts SET created = NOW() WHERE
username = '$username'");

$userid = get_item($dbh,"userid","accounts","username", $username);
$myrow = array($userid,"1","1");
add_row($dbh, "display", $myrow);

foreach (array(2,4,6,8,14) as $opt_link) {
	$myrow = array($userid,$opt_link);
	add_row($dbh, "opt_links", $myrow);
}


echo "Account created for " . $username . " with password " . $password . 
", email " . $email . ", and graduation year " . $gradyear . ".<br>";
?>
<form action="email.php" method="POST">
<input type="hidden" name="username" value="<?=$username?>">
<input type="hidden" name="password" value="<?=$password?>">
<input type="hidden" name="email" value="<?=$email?>">
<input type="hidden" name="whatoperation" value="create">
<input type="submit" value="Send Email">
</form>
<?
}
}//if user doesn't already exist
}//if username
else
{
?>
<form action="adduser.php" method="POST">
Username: <input type="text" name="username"><br>
Password: <input type="text" name="password"><br>
E-mail: <input type="text" name="email"><br>
Grad Year: <input type="text" name="gradyear"><br>
<input type="submit" value="Create Account">
</form> 
<?

}//if no username


db_disconnect($dbh);

?>
</body>
</html>
